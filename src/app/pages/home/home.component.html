<div class="dashboard-container">
  <!-- Loading indicator -->
  @if (isLoading) {
    <div class="loading-container">
      <mat-icon class="loading-icon">hourglass_empty</mat-icon>
      <p>Carregando dados...</p>
    </div>
  }
  
  <!-- Summary Cards -->
  <div class="cards-grid">
    @for (card of cards; track card.title) {
      <mat-card>
        <mat-card-content>
          <div class="card-content">
            <div class="card-info">
              <div class="card-title">{{card.title}}</div>
              <div class="card-value">{{card.value}}</div>
            </div>
            <div class="card-icon">
              <mat-icon>{{card.icon}}</mat-icon>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    }
  </div>
  
  <!-- Advanced Analysis Cards -->
  <div class="new-cards-grid">
    @for (card of newCards; track card.title) {
      @switch (card.type) {
        @case ('comparison') {
          <mat-card class="comparison-card">
            <mat-card-header>
              <mat-icon>{{card.icon}}</mat-icon>
              <mat-card-title>{{card.title}}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (getComparisonCard(card); as comparisonCard) {
                <div class="comparison-item">
                  <div class="label">{{comparisonCard.current.label}}</div>
                  <div class="value">{{comparisonCard.current.value}}</div>
                  <mat-progress-bar mode="determinate" 
                                  [value]="comparisonCard.current.percentage"
                                  color="primary">
                  </mat-progress-bar>
                </div>
                <div class="comparison-item">
                  <div class="label">{{comparisonCard.previous.label}}</div>
                  <div class="value">{{comparisonCard.previous.value}}</div>
                  <mat-progress-bar mode="determinate" 
                                  [value]="comparisonCard.previous.percentage"
                                  color="accent">
                  </mat-progress-bar>
                </div>
              }
            </mat-card-content>
          </mat-card>
        }
        @case ('timeline') {
          <mat-card class="timeline-card">
            <mat-card-header>
              <mat-icon>{{card.icon}}</mat-icon>
              <mat-card-title>{{card.title}}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (getTimelineCard(card); as timelineCard) {
                @if (timelineCard.activities.length === 0) {
                  <div class="no-data">
                    <p>Nenhuma atividade recente encontrada.</p>
                  </div>
                } @else {
                  @for (activity of timelineCard.activities; track activity.time) {
                    <div class="activity" [class]="activity.status">
                      <div class="time">{{activity.time}}</div>
                      <div class="description">{{activity.description}}</div>
                    </div>
                  }
                }
              }
            </mat-card-content>
          </mat-card>
        }
        @case ('distribution') {
          <mat-card class="distribution-card">
            <mat-card-header>
              <mat-icon>{{card.icon}}</mat-icon>
              <mat-card-title>{{card.title}}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              @if (getDistributionCard(card); as distributionCard) {
                <div class="total">
                  <div class="label">Total</div>
                  <div class="value">{{distributionCard.total}}</div>
                </div>
                <mat-divider></mat-divider>
                @if (distributionCard.categories.length === 0) {
                  <div class="no-data">
                    <p>Nenhuma categoria encontrada.</p>
                  </div>
                } @else {
                  @for (category of distributionCard.categories; track category.name) {
                    <div class="category">
                      <div class="color-indicator" [style.background-color]="category.color"></div>
                      <div class="name">{{category.name}}</div>
                      <div class="percentage">{{category.percentage}}%</div>
                    </div>
                  }
                }
              }
            </mat-card-content>
          </mat-card>
        }
      }
    }
  </div>

  <!-- Produtos com Estoque Crítico -->
  <div class="data-section">
    <div class="section-header">
      <h2>Produtos com Estoque Crítico</h2>
      <button mat-button color="primary" (click)="verProdutosCriticos()">
        Ver Todos <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
    
    @if (produtosCriticos.length === 0) {
      <div class="no-data-large">
        <mat-icon>check_circle</mat-icon>
        <p>Parabéns! Nenhum produto com estoque crítico.</p>
      </div>
    } @else {
      <div class="table-container mat-elevation-z2">
        <table mat-table [dataSource]="produtosCriticos">
          <!-- Nome Column -->
          <ng-container matColumnDef="nome">
            <th mat-header-cell *matHeaderCellDef>Nome</th>
            <td mat-cell *matCellDef="let produto">
              {{produto.nome}}
              <div class="product-category">
                @for (catId of produto.categoria.slice(0,1); track catId) {
                  <span class="category-chip">
                    {{Categoria[catId].replace('_', ' ')}}
                  </span>
                }
              </div>
            </td>
          </ng-container>

          <!-- Estoque Atual Column -->
          <ng-container matColumnDef="estoqueAtual">
            <th mat-header-cell *matHeaderCellDef>Estoque Atual</th>
            <td mat-cell *matCellDef="let produto">
              <strong>{{produto.estoqueAtual}}</strong>
              <div class="small-text">Mín: {{produto.estoqueMinimo}}</div>
            </td>
          </ng-container>

          <!-- Estoque Mínimo Column -->
          <ng-container matColumnDef="estoqueMinimo">
            <th mat-header-cell *matHeaderCellDef>Fornecedor</th>
            <td mat-cell *matCellDef="let produto">
              {{produto.fornecedor}}
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let produto">
              <div class="status-chip" [class]="getStatusEstoque(produto)">
                <span *ngIf="produto.estoqueAtual === 0">Zerado</span>
                <span *ngIf="produto.estoqueAtual > 0 && produto.estoqueAtual <= produto.estoqueMinimo">Baixo</span>
                <span *ngIf="produto.estoqueAtual > produto.estoqueMinimo">Normal</span>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    }
  </div>

  <!-- Produtos Mais Vendidos -->
  <div class="data-section">
    <div class="section-header">
      <h2>Produtos Mais Vendidos</h2>
      <button mat-button color="primary" (click)="verMovimentacoes()">
        Ver Movimentações <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>

    @if (produtosMaisVendidos.length === 0) {
      <div class="no-data-large">
        <mat-icon>info</mat-icon>
        <p>Ainda não há registros de vendas concluídas.</p>
      </div>
    } @else {
      <div class="products-grid">
        @for (item of produtosMaisVendidos; track item.produto.id) {
          <div class="product-card mat-elevation-z2">
            <div class="product-ranking">{{$index + 1}}</div>
            <div class="product-details">
              <div class="product-name">{{item.produto.nome}}</div>
              <div class="product-category">
                @for (catId of item.produto.categoria; track catId) {
                  <span class="category-chip">
                    {{Categoria[catId].replace('_', ' ')}}
                  </span>
                }
              </div>
              <div class="product-stats">
                <span class="qty-sold">
                  <mat-icon>shopping_cart</mat-icon> {{item.qtdVendida}} vendidos
                </span>
                <span class="price">
                  <mat-icon>attach_money</mat-icon> {{item.produto.precoVenda | currency:'BRL'}}
                </span>
              </div>
            </div>
          </div>
        }
      </div>
    }
  </div>
  
  <!-- Vendas por Plataforma -->
  <div class="data-section">
    <div class="section-header">
      <h2>Vendas por Plataforma</h2>
    </div>

    @if (vendasPorPlataforma.length === 0) {
      <div class="no-data-large">
        <mat-icon>info</mat-icon>
        <p>Ainda não há registros de vendas concluídas.</p>
      </div>
    } @else {
      <div class="platform-stats-container">
        @for (item of vendasPorPlataforma; track item.plataforma) {
          <div class="platform-card mat-elevation-z1">
            <div class="platform-name">
              <span class="platform-indicator" 
                   [style.background-color]="plataformaColors[item.plataforma.replace(' ', '_')] || '#757575'"></span>
              {{item.plataforma}}
            </div>
            <div class="platform-value">{{item.total | currency:'BRL'}}</div>
            <mat-progress-bar mode="determinate" 
                             [value]="item.percentual"
                             color="accent">
            </mat-progress-bar>
            <div class="platform-percentage">{{item.percentual}}% das vendas</div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Análise de Tendências de Produtos com IA -->
  <div class="data-section">
    <div class="section-header">
      <h2>Análise de Mercado com IA</h2>
      <button mat-raised-button color="accent" (click)="demonstrarAnaliseIA()">
        <mat-icon>analytics</mat-icon>
        Demonstrar Análise
      </button>
    </div>
    
    <app-ai-trends-card [produtos]="produtos"></app-ai-trends-card>
  </div>
</div>